//                                                     ..'''.                                            .''''..
//                                                .,ccoddkOl.                                            .;xOddxlc;.
//                                               ;oolc;.lk,                                                 ox';:cddc.
//                                              cx,;oc, lO:                                                .xk.':lc'dd.
//                                             .xc cx,;;.cxxc.                                           ,okd'.:'ox.'x:
//                                             'x; 'Oc.,;,,:l;,c;.              .'...'.             .,c;'cl;,;;.'kl .dc
//                                             .dl  ck; .',..cOxdxxo:'.    .',:ddxOkxddc,,..    .;cdxddOx..',. .xd. ,k;
//                                              ,x:  :kl.   l0c.:ollddc;clllc:dO:c0ko;dk:ccclc::odolol',Ok.   ,xd. .dl
//                                               ;x:  'dk, ;0l  .lxocclc;'... :x,:Odo,oo  ...,cllclkd,  ,Oo .dk:  'dl.
//                                                'xo. .;,.ok.   .lxl'.,looc,.od.oNXO,ck'.:loo:..:dd'    lO'.c.  ;xc.
//                                                 .ox,   '0o   ;dc..:kNN0o;.'xo:KMWNock:.,lkXWKo'.;oc.  ;Kl   .ox,
//                                                   ;xo' cX: .oo,;o0WWMWWXO0X0x00xxOKxkXKOKNWMMWXx:'cx; .Ox..cko.
//                                                    .lc.cK:,OKdx00OOkkxxddddxKO;'c:oXkddddxxkkOOO0kdOKl.xx.,o'
//                                                        ,o:oOkkxdollclddllllOWl.,o;,KKollcldlcclodxxkkx:lc
//                          .lxxxxxxxddxxxxxxxxxxxxxxxxxc..ddc:lkxcccc:lkxl:cl0Ml.ckc,KKdcccoko::cccoOocclx;,dxxxxxxxxxxxxxxxxxxxxxxxddxo'
//                           cXMMWNK0000000000000000000NK,.xx::codlcclooxkx:,,kWl;kKo;K0c,;okxdolcccllc::ok:lWWX00XWMNK000000000000KNWMNd.
//                            :KMWKl.....'::'... .... .xWk''c,...':oc,,,:ol;'.oNOkKXOkXk'.;coc,,,;:.... .:;.oMK:;;:KM0, .  .,:;....dNMXl.
//                             ,0WMXl.   .xN0;        .xMWc;k,.,::,lx:;lodl::ckx;'''''oOo::codo:,'..;:;..dl.dMN0X0;dMNc    .xWK; .xNMKc
//                              .xWMNx.   .oNXc       .xMWc,k; ckdxo,..lxxo::oo'      .:oc:ldxd;..:xxkl..dc.kWMWO; :NMx.    lNMd,kWW0,
//                               .oNWWO,    cXNd.      oWWo'xl .o0xOOc..,,.'c;          .c;.','.;k0xOx. ,x;,KWWd.  .okl,,;l:;OMNXWWk.
//                                 :KMWK:    ,0Wk'     ;KMO,:: :dx0xkXO;   ::   ..','.   'l.  'xXOx0kdl.'c.oWW0,.';cdkOXNNKx,oMMWNd.
//                                  'kWWXo.   .xNK:    .dWWo'c,'xxd0dc:. .c:. .cONWWNKd.  'c;..;:o0xdk;.c,,KMW0:lNWX0kxdc'. .kWWXc
//                                   .dNWWk.   .oNXl.   'OWXc':;;cl;.   :l.   ,OKNMMWKKl   .:l.  .,cc;,:;,OWMMWo':,..;k0c  'kWWO,
//                                    .cXMW0;    :KNx.   'OWXl,loc,.   ;l.    .;,:kKd';.     cc   .';oo;;OMXOXMO.    ;KMk.;KWNd.
//                                      ,0WWXc    ,OW0,   .xNNx;cxk;.  cc        .ckc        ,o.  'dOo,cKM0;.dXk, .'''kMXcoKx,
//                                       .kWMNd.   .xWK:   .cKWKo;o0k,.cc       ;cccc:.      ,o'.o0x:ckNNx'..cddxOKXXccNWd..
//                                        .oNMWk'   .lNNo.   'xNW0l;cocc:,,,,;::;.   'c:;;;,';ccol:cxNMWd:x0XNN0Oxo:,.:XWx.
//                                          :KWWK:    :KWk'    ;xXW0l'',.......        .......,'.;kNNNWWd;ooc:cdxc.  .xWX:
//                                           ,OWMNo.   ,OW0;     ,OMNl.   .','.        ..',.    :KMNl:0W0,    '0M0, ;kWXc
//                                            .xWMWx.   .dNXc     cNWo .'....;;;;:::;;;;;'...'. cNMx. dWNl    .dWWl;KXx,
//                                             .oXMWO,   .lXNd.   .kMKcl0:;l.    .....    c:'kd;OMK,  'oxocoxOlcKMk;;'
//                                               :KWWKc    ;KWk'   ,OWNNWo.xx.          .ok':XNXWXo:ldk0NNXKOx;'kMK,
//                                                'kWWNd.   'kWK:   'xNMMk.,o;.         ;d;.oWMWWxl0XOxddxl.   ,KMk.
//                                                 .dNMWk'   .dNXl.   ,dXN:.l0c        ,Ox',0N0XM0;..  .xWK;  ;0W0,
//                                                  .cXMMK;   .cXNx.    cNK0WWx.       lWWK0Nd.dMWl     oWWo.dXNk'
//                                                    ;0WMXl.   ;0WO,   .oNKONNl      ;KMMMWx. ;OOc..,c,:KMO:ox;
//                                                     'kWMNd.   .kWK:   .;'.xWX:    ,0MWWOc'.'cdxkKXNNx,xMX:
//                                                      .dNMWO,   .dNNo.     'OMK:. 'OWWMMd,xKNWX0kdl;,..xMX:
//                                                        cXMMKc    :KWx.     ,0MXOdOWXOXMO;:l:,,ckx,   cXWx.
//                                                         ;0WWNo.   ,OW0;     ;KMMMWNd,xMNc     oWWo.'xNWx.
//                                                          .xNWWk'   .xNXc.    oWMW0;  cNMx.   .;XMO;xNO:.
//                                                           .oXWM0;   .lXNd.  ,KMMO'   .lxdlox0x;xMNc',.
//                                                             :KMMXl.   :KWk' lWWWo.,ldk0XNNKOxc.lWWl
//                                                              'OWWNx.   'OW0;lNMMx;kX0kdodo,   .xWX;
//                                                               .dNMW0;   cXWx:0MMK;... .lNNc  .xWXl.
//                                                                .lXMMKc'oNWO;.dWMWo     cNMk':KW0:
//                                                                  ;0WMNXWNo.  :0K0l..';,;OWK:lkc.
//                                                                   'kWMMMNkc;,;odddkKNW0;oWWo.
//                                                                    .oNMMMWWWWWNNX0kdc;..oWWo
//                                                                      :KMMW0l::;;cddc.  ,0MK,
//                                                                       ,OWWNd.   ,OWWKddKWNl
//                                                                        .xNWWk'   .;dKWWMNo.
//                                                                         .lXMW0;.   'OMMK:
//                                                                           ;0MMXOl.:KWW0,
//                                                                            'kWMMWXNWNk.
//                                                                             .oNMMMMNo.
//                                                                               :xKMXl.
//                                                                                 'o:


//ShibaVikingsClan NFT
//https://linktr.ee/shiba_vikings_nft

// SPDX-License-Identifier: MIT

pragma solidity >=0.8.0 <0.9.0;

import "./Libraries.sol";
contract shibavikingclanNFT is ERC721Enumerable, Ownable {
    using Strings for uint256;

    string baseURI;
    string public baseExtension = ".json";
    uint256 public cost = 0.08 ether;
    uint256 public maxSupply = 7000;
    uint256 public maxMintAmount = 100;
    bool public paused = false;
    bool public revealed = false;
    string public notRevealedUri;
    bool public isAllowListActive = true;

    mapping(address => uint8) public _allowList;

    constructor(
        string memory _name,
        string memory _symbol,
        string memory _initBaseURI,
        string memory _initNotRevealedUri
    ) ERC721(_name, _symbol) {
        setBaseURI(_initBaseURI);
        setNotRevealedURI(_initNotRevealedUri);
    }

    // internal
    function _baseURI() internal view virtual override returns (string memory) {
        return baseURI;
    }

    // Mint public
    function mint(uint8 _mintAmount) public payable {
        uint256 supply = totalSupply();

        require(_mintAmount > 0);
        require(_mintAmount <= maxMintAmount);
        require(supply + _mintAmount <= maxSupply);

        if (msg.sender != owner()) {
            require(!paused);
            require(msg.value >= cost * _mintAmount);
            if (isAllowListActive) {
                require(
                    _mintAmount <= _allowList[msg.sender],
                    "Exceeded max available to purchase"
                );
                _allowList[msg.sender] -= _mintAmount;
            }
        }

        for (uint256 i = 1; i <= _mintAmount; i++) {
            _safeMint(msg.sender, supply + i);
            if (claimPerNFT > 0) ClaimedAmountOfNFT[supply + i] = claimPerNFT;
        }
    }

    //whitelist and presale functions
    function setIsAllowListActive(bool _isAllowListActive) external onlyOwner {
        isAllowListActive = _isAllowListActive;
    }

    function setAllowList(address[] calldata addresses, uint8 numAllowedToMint)
        external
        onlyOwner
    {
        for (uint256 i = 0; i < addresses.length; i++) {
            _allowList[addresses[i]] = numAllowedToMint;
        }
    }

    function numAvailableToMint(address addr) external view returns (uint8) {
        return _allowList[addr];
    }

    // Misc
    function walletOfOwner(address _owner)
        public
        view
        returns (uint256[] memory)
    {
        uint256 ownerTokenCount = balanceOf(_owner);
        uint256[] memory tokenIds = new uint256[](ownerTokenCount);
        for (uint256 i; i < ownerTokenCount; i++) {
            tokenIds[i] = tokenOfOwnerByIndex(_owner, i);
        }
        return tokenIds;
    }

    function tokenURI(uint256 tokenId)
        public
        view
        virtual
        override
        returns (string memory)
    {
        require(
            _exists(tokenId),
            "ERC721Metadata: URI query for nonexistent token"
        );

        if (revealed == false) {
            return notRevealedUri;
        }

        string memory currentBaseURI = _baseURI();
        return
            bytes(currentBaseURI).length > 0
                ? string(
                    abi.encodePacked(
                        currentBaseURI,
                        tokenId.toString(),
                        baseExtension
                    )
                )
                : "";
    }

    //only owner
    function reveal() public onlyOwner {
        revealed = true;
    }

    function setCost(uint256 _newCost) public onlyOwner {
        cost = _newCost;
    }

    function setmaxMintAmount(uint256 _newmaxMintAmount) public onlyOwner {
        maxMintAmount = _newmaxMintAmount;
    }

    function setNotRevealedURI(string memory _notRevealedURI) public onlyOwner {
        notRevealedUri = _notRevealedURI;
    }

    function setBaseURI(string memory _newBaseURI) public onlyOwner {
        baseURI = _newBaseURI;
    }

    function setBaseExtension(string memory _newBaseExtension)
        public
        onlyOwner
    {
        baseExtension = _newBaseExtension;
    }

    function pause(bool _state) public onlyOwner {
        paused = _state;
    }

    function withdraw() public payable onlyOwner {
        // Do not remove this otherwise you will not be able to withdraw the funds.
        // =============================================================================
        (bool os, ) = payable(owner()).call{value: address(this).balance}("");
        require(os);
        // =============================================================================
    }

    //@dev adds Shiba inu rewards system to nfts

    mapping(uint256 => uint256) ClaimedAmountOfNFT;

    uint256 public claimPerNFT;
    uint256 public totalClaimGlobal;
    IERC20 shiba = IERC20(0x95aD61b0a150d79219dCF64E1E6Cc01f0B64C4cE);
    //IERC20 shiba = IERC20(0x78867BbEeF44f2326bF8DDd1941a4439382EF2A7);//Testnet BUSD
    bool _isInFunction;
    modifier inFunction() {
        require(!_isInFunction);
        _isInFunction = true;
        _;
        _isInFunction = false;
    }

    function OwnerClaimETH() public onlyOwner {
        (bool sent, ) = msg.sender.call{value: address(this).balance}("");
        require(sent);
    }

    event AddShiba(uint256 amount);

    function AddTokens(uint256 amount) public inFunction {
        require(revealed, "Not revealed yet");
        shiba.transferFrom(msg.sender, address(this), amount);
        uint256 amountPerNFT = amount / totalSupply();
        claimPerNFT += amountPerNFT;
        totalClaimGlobal += amount;
        emit AddShiba(amount);
    }

    function getClaimLeftForNFT(uint256 ID) public view returns (uint256) {
        return claimPerNFT - ClaimedAmountOfNFT[ID];
    }

    function getDividents(address account) external view returns (uint256) {
        uint256 totalAmount = 0;
        for (uint256 i = 0; i < balanceOf(account); i++) {
            uint256 ID = tokenOfOwnerByIndex(account, i);
            uint256 claimLeft = getClaimLeftForNFT(ID);
            totalAmount += claimLeft;
        }
        return totalAmount;
    }

    function _resetDividents(address account) private returns (uint256) {
        uint256 totalAmount = 0;
        for (uint256 i = 0; i < balanceOf(account); i++) {
            uint256 ID = tokenOfOwnerByIndex(account, i);
            uint256 claimLeft = getClaimLeftForNFT(ID);
            ClaimedAmountOfNFT[ID] = claimPerNFT;
            totalAmount += claimLeft;
        }
        return totalAmount;
    }

    function ClaimShiba() external inFunction {
        uint256 totalClaim = _resetDividents(msg.sender);
        shiba.transfer(msg.sender, totalClaim);
    }
}